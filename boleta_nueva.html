{% extends "base.html" %}
{% block title %}Nueva Boleta ¬∑ Lavander√≠a R√çOS{% endblock %}
{% block content %}
<section class="card">
  <h2 class="title">NUEVA BOLETA</h2>

  <form method="post" id="boletaForm" class="form-grid">
    <!-- Cabecera -->
    <label>
      CLIENTE
  <input type="text" name="cliente" required class="form-input" autocomplete="name" aria-label="Nombre del cliente" />
    </label>
    <label>
      DIRECCI√ìN
  <input type="text" name="direccion" value="{{ LAVA_DIRECCION }}" class="form-input" autocomplete="street-address" aria-label="Direcci√≥n" />
    </label>
    <label>
      TEL√âFONO
  <input type="tel" name="telefono" placeholder="9XXXXXXXX" class="form-input" autocomplete="tel" inputmode="tel" aria-label="Tel√©fono" />
    </label>
    <label>
      M√âTODO DE PAGO
      <select name="metodo_pago" class="form-select">
        <option value="efectivo">EFECTIVO</option>
        <option value="yape">YAPE</option>
        <option value="plin">PLIN</option>
        <option value="tarjeta">TARJETA</option>
      </select>
    </label>
    <label>
      Entrega (fecha)
  <input type="date" name="entrega_fecha" aria-label="Fecha de entrega" />
    </label>
    <label>
      Entrega (hora)
  <input type="time" name="entrega_hora" aria-label="Hora de entrega" />
    </label>
    <label>
      A cuenta (S/)
  <input type="number" name="a_cuenta" step="0.01" value="0" inputmode="decimal" aria-label="A cuenta" />
    </label>
    <label class="full">
      Notas
  <input type="text" name="notas" placeholder="Ej: Martes 5 pm, perfumado suave..." autocomplete="off" aria-label="Notas" />
    </label>

    <!-- √çtems -->
    <div class="full">
      <div class="items-header">
        <div>Descripci√≥n</div>
        <div>Tipo</div>
        <div>Cantidad</div>
        <div>Lavado</div>
        <div>Perfumado</div>
        <div>P. Unit</div>
        <div>Importe</div>
        <div></div>
      </div>
      <div id="items"></div>
      <button type="button" class="btn" onclick="addItem()">‚ûï Agregar √≠tem</button>
    </div>

    <div class="full totals">
      <div><strong>Total:</strong> S/ <span id="total">0.00</span></div>
      <div><strong>Saldo:</strong> S/ <span id="saldo">0.00</span></div>
    </div>

    <div class="form-actions">
      <button class="btn" type="submit">üíæ Guardar boleta</button>
      <a class="btn secondary" href="{{ url_for('boletas') }}">üìã Ver boletas</a>
    </div>
  </form>
</section>

<script>
  const PRECIO_DEFAULT = 3.00;

  function fmt(n){ return (Math.round(n*100)/100).toFixed(2); }

  function addItem(pref = {}) {
    const row = document.createElement('div');
    row.className = 'item-row';
    row.innerHTML = `
      <input name="item_desc[]" placeholder="Descripci√≥n del art√≠culo..." value="${pref.desc || ''}">
      <select name="item_tipo" onchange="onTipoChange(this)" class="form-select">
        <option value="kilo" ${pref.tipo==='kilo'?'selected':''}>KILO</option>
        <option value="unidad" ${pref.tipo==='unidad'?'selected':''}>UNIDAD</option>
      </select>
      <input name="item_cantidad[]" type="number" step="0.5" min="0" value="${pref.cantidad || 1}" class="form-input">
      <select name="item_lavado[]">
        <option>Normal</option>
        <option>Seco</option>
        <option>A mano</option>
      </select>
      <input name="item_perfumado[]" type="checkbox" value="1" ${pref.perfumado?'checked':''}>
      <input type="hidden" name="item_perfumado_hidden[]" value="0">
      <input name="item_punit[]" type="number" step="0.01" min="0" value="${pref.pu || PRECIO_DEFAULT}">
      <input name="item_importe_vis[]" value="0.00" disabled>
      <button type="button" class="btn danger" onclick="removeItem(this)">‚úñ</button>
      <input type="hidden" name="item_tipo[]">
    `;
    // Copiamos el valor visual del select al input hidden para que Flask lo reciba como lista "item_tipo[]"
    const sel = row.querySelector('select[name="item_tipo"]');
    const hidden = row.querySelector('input[type="hidden"][name="item_tipo[]"]');
    const sync = () => hidden.value = sel.value;
    sel.addEventListener('change', sync); sync();

    document.getElementById('items').appendChild(row);
    onTipoChange(sel);
    recalc();
  }

  function onTipoChange(sel){
    const row = sel.parentElement;
    const tipo = sel.value;
    const pu = row.querySelector('input[name="item_punit[]"]');
    pu.value = PRECIO_DEFAULT;
    recalc();
  }

  function removeItem(btn){
    btn.parentElement.remove();
    recalc();
  }

  function recalc(){
    let total = 0;
    document.querySelectorAll('#items .item-row').forEach(row=>{
      const cantidad = parseFloat(row.querySelector('input[name="item_cantidad[]"]').value || 0);
      const pu = parseFloat(row.querySelector('input[name="item_punit[]"]').value || 0);
      const imp = cantidad * pu;
      row.querySelector('input[name="item_importe_vis[]"]').value = fmt(imp);
      total += imp;
    });
    const aCuenta = parseFloat(document.querySelector('input[name="a_cuenta"]').value || 0);
    document.getElementById('total').innerText = fmt(total);
    document.getElementById('saldo').innerText = fmt(total - aCuenta);
  }

  document.getElementById('boletaForm').addEventListener('input', recalc);
  // Primera fila por defecto
  addItem({tipo:'kilos'});
</script>
{% endblock %}
